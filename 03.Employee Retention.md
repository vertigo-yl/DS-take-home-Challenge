

```python
import  warnings
warnings.simplefilter('ignore')

import numpy as np
import pandas as pd
import seaborn as sns
import matplotlib.pyplot as plt
import graphviz
from sklearn import tree
from sklearn.tree import DecisionTreeClassifier
from sklearn.preprocessing import LabelEncoder

%matplotlib inline
```


```python
cd ../dataset/
```

    /Users/luyao/Desktop/求职/DS-Take-Home/dataset



```python
data = pd.read_csv('employee_retention_data.csv', parse_dates=['join_date', 'quit_date'])
data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>employee_id</th>
      <th>company_id</th>
      <th>dept</th>
      <th>seniority</th>
      <th>salary</th>
      <th>join_date</th>
      <th>quit_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13021.0</td>
      <td>7</td>
      <td>customer_service</td>
      <td>28</td>
      <td>89000.0</td>
      <td>2014-03-24</td>
      <td>2015-10-30</td>
    </tr>
    <tr>
      <th>1</th>
      <td>825355.0</td>
      <td>7</td>
      <td>marketing</td>
      <td>20</td>
      <td>183000.0</td>
      <td>2013-04-29</td>
      <td>2014-04-04</td>
    </tr>
    <tr>
      <th>2</th>
      <td>927315.0</td>
      <td>4</td>
      <td>marketing</td>
      <td>14</td>
      <td>101000.0</td>
      <td>2014-10-13</td>
      <td>NaT</td>
    </tr>
    <tr>
      <th>3</th>
      <td>662910.0</td>
      <td>7</td>
      <td>customer_service</td>
      <td>20</td>
      <td>115000.0</td>
      <td>2012-05-14</td>
      <td>2013-06-07</td>
    </tr>
    <tr>
      <th>4</th>
      <td>256971.0</td>
      <td>2</td>
      <td>data_science</td>
      <td>23</td>
      <td>276000.0</td>
      <td>2011-10-17</td>
      <td>2014-08-22</td>
    </tr>
  </tbody>
</table>
</div>




```python
data.info()
```

    <class 'pandas.core.frame.DataFrame'>
    RangeIndex: 24702 entries, 0 to 24701
    Data columns (total 7 columns):
    employee_id    24702 non-null float64
    company_id     24702 non-null int64
    dept           24702 non-null object
    seniority      24702 non-null int64
    salary         24702 non-null float64
    join_date      24702 non-null datetime64[ns]
    quit_date      13510 non-null datetime64[ns]
    dtypes: datetime64[ns](2), float64(2), int64(2), object(1)
    memory usage: 1.3+ MB



```python
data.describe(include = 'all')
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>employee_id</th>
      <th>company_id</th>
      <th>dept</th>
      <th>seniority</th>
      <th>salary</th>
      <th>join_date</th>
      <th>quit_date</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>count</th>
      <td>24702.000000</td>
      <td>24702.000000</td>
      <td>24702</td>
      <td>24702.000000</td>
      <td>24702.000000</td>
      <td>24702</td>
      <td>13510</td>
    </tr>
    <tr>
      <th>unique</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>6</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>995</td>
      <td>664</td>
    </tr>
    <tr>
      <th>top</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>customer_service</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2012-01-03 00:00:00</td>
      <td>2015-05-08 00:00:00</td>
    </tr>
    <tr>
      <th>freq</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>9180</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>105</td>
      <td>111</td>
    </tr>
    <tr>
      <th>first</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2011-01-24 00:00:00</td>
      <td>2011-10-13 00:00:00</td>
    </tr>
    <tr>
      <th>last</th>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>NaN</td>
      <td>2015-12-10 00:00:00</td>
      <td>2015-12-09 00:00:00</td>
    </tr>
    <tr>
      <th>mean</th>
      <td>501604.403530</td>
      <td>3.426969</td>
      <td>NaN</td>
      <td>14.127803</td>
      <td>138183.345478</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>std</th>
      <td>288909.026101</td>
      <td>2.700011</td>
      <td>NaN</td>
      <td>8.089520</td>
      <td>76058.184573</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>min</th>
      <td>36.000000</td>
      <td>1.000000</td>
      <td>NaN</td>
      <td>1.000000</td>
      <td>17000.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>25%</th>
      <td>250133.750000</td>
      <td>1.000000</td>
      <td>NaN</td>
      <td>7.000000</td>
      <td>79000.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>50%</th>
      <td>500793.000000</td>
      <td>2.000000</td>
      <td>NaN</td>
      <td>14.000000</td>
      <td>123000.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>75%</th>
      <td>753137.250000</td>
      <td>5.000000</td>
      <td>NaN</td>
      <td>21.000000</td>
      <td>187000.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
    <tr>
      <th>max</th>
      <td>999969.000000</td>
      <td>12.000000</td>
      <td>NaN</td>
      <td>99.000000</td>
      <td>408000.000000</td>
      <td>NaN</td>
      <td>NaN</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Null information
data.isnull().sum()
```




    employee_id        0
    company_id         0
    dept               0
    seniority          0
    salary             0
    join_date          0
    quit_date      11192
    dtype: int64



## Create a table with 3 columns: day, employee_headcount, company_id.


```python
unique_date = pd.date_range(start='2011-01-24', end='2015-12-13', freq='D')
unique_company = sorted(data['company_id'].unique())
```


```python
day = []
company = []
headcount = []

for date in unique_date:
    for idx in unique_company:
        total_join = len(data[(data['join_date'] <= date) & (data['company_id'] == idx)])
        total_quit = len(data[(data['quit_date'] <= date) & (data['company_id'] == idx)])
        day.append(date)
        company.append(idx)
        headcount.append(total_join - total_quit)
        
# Create table for day, employee_headcount, company_id
table = pd.DataFrame({'day': day, 'company_id': company, 'employee_headcount': headcount}, 
                     columns=['day', 'company_id', 'employee_headcount'])
```


```python
table.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>day</th>
      <th>company_id</th>
      <th>employee_headcount</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>2011-01-24</td>
      <td>1</td>
      <td>25</td>
    </tr>
    <tr>
      <th>1</th>
      <td>2011-01-24</td>
      <td>2</td>
      <td>17</td>
    </tr>
    <tr>
      <th>2</th>
      <td>2011-01-24</td>
      <td>3</td>
      <td>9</td>
    </tr>
    <tr>
      <th>3</th>
      <td>2011-01-24</td>
      <td>4</td>
      <td>12</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2011-01-24</td>
      <td>5</td>
      <td>5</td>
    </tr>
  </tbody>
</table>
</div>



## Employee Churn Analysis

### Feature Engineering

how many days was the employee be employed? This should matter.
People might get bored in the same place for too long.


```python
# Separate stay and quit data
quit_data = data[~data['quit_date'].isnull()]
stay_data = data[data['quit_date'].isnull()]
```


```python
workdays = np.array(list(map(lambda x: x.days, quit_data['quit_date'] - quit_data['join_date'])))

hist_kws={'histtype': 'bar', 'edgecolor':'black', 'alpha': 0.2}
fig, ax = plt.subplots(figsize=(15, 6))
sns.distplot(workdays, bins=100, kde=False, ax=ax, hist_kws=hist_kws)
ax.set_title('Histogram of Working Days', fontsize=16)
ax.set_xlabel('Working Days', fontsize=12)
ax.set_ylabel('Frequency', fontsize=12)
plt.show()
```


![png](output_12_0.png)


This graph shows that people are easy to get boring and quit around 1 year.


```python
month = np.array(list(map(lambda x: x.month, quit_data['quit_date'] )))

fig, ax = plt.subplots(figsize=(15, 6))
sns.countplot(month, ax=ax)
ax.set_title('Count of Quit months', fontsize=16)
ax.set_xlabel('Quit months', fontsize=12)
ax.set_ylabel('Frequency', fontsize=12)
plt.show()
```


![png](output_14_0.png)



```python
weeks  = np.array(list(map(lambda x: x.week, quit_data['quit_date'])))

hist_kws={'histtype': 'bar', 'edgecolor':'black', 'alpha': 0.2}
fig, ax = plt.subplots(figsize=(15, 6))
sns.distplot(weeks , bins=50, kde=False, ax=ax, hist_kws=hist_kws)
ax.set_title('Histogram of Quit Weeks', fontsize=16)
ax.set_xlabel('Quit Weeks', fontsize=12)
ax.set_ylabel('Frequency', fontsize=12)
plt.show()
```


![png](output_15_0.png)


And it also peaks around the new year. Makes sense, companies have much more money to hire at the beginning of the year.

Now, let’s see if we find the characteristics of the people who quit early. Looking at the histogram of employment_length, it looks like we could define early quitters as those people who quit within 1 yr or so. So, let’s create two classes of users : quit within 13 months or not (if they haven’t been in the current company for at least 13 months, we remove them).


```python
# Choose quit data
quit_data['workdays'] = workdays
quit_data['weeks'] = weeks

quit_data.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>employee_id</th>
      <th>company_id</th>
      <th>dept</th>
      <th>seniority</th>
      <th>salary</th>
      <th>join_date</th>
      <th>quit_date</th>
      <th>workdays</th>
      <th>weeks</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13021.0</td>
      <td>7</td>
      <td>customer_service</td>
      <td>28</td>
      <td>89000.0</td>
      <td>2014-03-24</td>
      <td>2015-10-30</td>
      <td>585</td>
      <td>44</td>
    </tr>
    <tr>
      <th>1</th>
      <td>825355.0</td>
      <td>7</td>
      <td>marketing</td>
      <td>20</td>
      <td>183000.0</td>
      <td>2013-04-29</td>
      <td>2014-04-04</td>
      <td>340</td>
      <td>14</td>
    </tr>
    <tr>
      <th>3</th>
      <td>662910.0</td>
      <td>7</td>
      <td>customer_service</td>
      <td>20</td>
      <td>115000.0</td>
      <td>2012-05-14</td>
      <td>2013-06-07</td>
      <td>389</td>
      <td>23</td>
    </tr>
    <tr>
      <th>4</th>
      <td>256971.0</td>
      <td>2</td>
      <td>data_science</td>
      <td>23</td>
      <td>276000.0</td>
      <td>2011-10-17</td>
      <td>2014-08-22</td>
      <td>1040</td>
      <td>34</td>
    </tr>
    <tr>
      <th>5</th>
      <td>509529.0</td>
      <td>4</td>
      <td>data_science</td>
      <td>14</td>
      <td>165000.0</td>
      <td>2012-01-30</td>
      <td>2013-08-30</td>
      <td>578</td>
      <td>35</td>
    </tr>
  </tbody>
</table>
</div>



## Model


```python
early_quit_date = pd.to_datetime('2015-12-13') - pd.DateOffset(days=365 + 31)
subset = data[data['join_date'] < early_quit_date]
```


```python
# Binary label for early quit (less than 13 months)
quit = subset['quit_date'].notnull() & (subset['quit_date'] < subset['join_date'] + pd.DateOffset(days=396))
subset['quit'] = quit.astype(int)

subset.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>employee_id</th>
      <th>company_id</th>
      <th>dept</th>
      <th>seniority</th>
      <th>salary</th>
      <th>join_date</th>
      <th>quit_date</th>
      <th>quit</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>13021.0</td>
      <td>7</td>
      <td>customer_service</td>
      <td>28</td>
      <td>89000.0</td>
      <td>2014-03-24</td>
      <td>2015-10-30</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>825355.0</td>
      <td>7</td>
      <td>marketing</td>
      <td>20</td>
      <td>183000.0</td>
      <td>2013-04-29</td>
      <td>2014-04-04</td>
      <td>1</td>
    </tr>
    <tr>
      <th>2</th>
      <td>927315.0</td>
      <td>4</td>
      <td>marketing</td>
      <td>14</td>
      <td>101000.0</td>
      <td>2014-10-13</td>
      <td>NaT</td>
      <td>0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>662910.0</td>
      <td>7</td>
      <td>customer_service</td>
      <td>20</td>
      <td>115000.0</td>
      <td>2012-05-14</td>
      <td>2013-06-07</td>
      <td>1</td>
    </tr>
    <tr>
      <th>4</th>
      <td>256971.0</td>
      <td>2</td>
      <td>data_science</td>
      <td>23</td>
      <td>276000.0</td>
      <td>2011-10-17</td>
      <td>2014-08-22</td>
      <td>0</td>
    </tr>
  </tbody>
</table>
</div>



Then we build the model:
Here we can just care about: seniority, salary, dept and company. A simple decision tree is probably more than enough.


```python
#LabelEncoder

le = LabelEncoder()
train_x = subset[['company_id', 'seniority', 'salary']]
train_x['dept'] = le.fit_transform(subset['dept'])
train_y = subset['quit'].values

train_x.head()
```




<div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>company_id</th>
      <th>seniority</th>
      <th>salary</th>
      <th>dept</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>7</td>
      <td>28</td>
      <td>89000.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>7</td>
      <td>20</td>
      <td>183000.0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>2</th>
      <td>4</td>
      <td>14</td>
      <td>101000.0</td>
      <td>4</td>
    </tr>
    <tr>
      <th>3</th>
      <td>7</td>
      <td>20</td>
      <td>115000.0</td>
      <td>0</td>
    </tr>
    <tr>
      <th>4</th>
      <td>2</td>
      <td>23</td>
      <td>276000.0</td>
      <td>1</td>
    </tr>
  </tbody>
</table>
</div>




```python
# Build decision tree
clf = DecisionTreeClassifier(max_depth=3, min_samples_leaf=30, random_state=42)
clf = clf.fit(X=train_x, y=train_y)
```


```python
# Feature importance
importance = sorted(zip(features, clf.feature_importances_), key=lambda x:x[1], reverse=True)
for feature, val in importance:
    print('{0:10s} | {1:.5f}'.format(feature, val))
```

    salary     | 1.00000
    company_id | 0.00000
    seniority  | 0.00000
    dept       | 0.00000



```python
# Visualization
hist_kws={'histtype': 'bar', 'edgecolor':'black', 'alpha': 0.2}
fig, ax = plt.subplots(figsize=(15, 7))
sns.distplot(subset[subset['quit']==0]['salary'], 
             label='Not Quit', ax=ax, hist_kws=hist_kws)
sns.distplot(subset[subset['quit']==1]['salary'], 
             label='Quit', ax=ax, hist_kws=hist_kws)
ax.set_xlabel('Salary', fontsize=12)
ax.set_ylabel('PDF', fontsize=12)
ax.legend()
plt.show()
```


![png](output_25_0.png)



```python

```
